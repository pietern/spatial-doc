

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Hello, Spatial! &mdash; Spatial 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Spatial 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Tutorial" href="../tutorial.html"/>
        <link rel="next" title="2. The Spatial Programming Model" href="model.html"/>
        <link rel="prev" title="0. Getting Started" href="starting.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Spatial
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../common.html">Common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software.html">Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Hardware</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="starting.html">0. Getting Started</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Hello, Spatial!</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spatial-app-structure">Spatial App Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling">Compiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#synthesizing-and-testing">Synthesizing and Testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="model.html">2. The Spatial Programming Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="memories.html">3. Memory Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="controllers.html">4. Controller Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="transfers.html">5. Transfer Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="dse.html">6. Design Space Exploration with Spatial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theory.html">Theory</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spatial</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
        
      <li>1. Hello, Spatial!</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/helloworld.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hello-spatial">
<h1>1. Hello, Spatial!<a class="headerlink" href="#hello-spatial" title="Permalink to this headline">¶</a></h1>
<p>Now that you have cloned all of the code and set all of your environment variables, let&#8217;s look at how to write, build, and run your first Spatial app!</p>
<div class="section" id="spatial-app-structure">
<h2>Spatial App Structure<a class="headerlink" href="#spatial-app-structure" title="Permalink to this headline">¶</a></h2>
<p>All Spatial programs have a few basic components. The following code example shows each of those components:</p>
<div class="highlight-Scala"><div class="highlight"><pre><span></span><span class="c1">// 1. Imports</span>
<span class="k">import</span> <span class="nn">org.virtualized._</span>
<span class="k">import</span> <span class="nn">spatial._</span>

<span class="c1">// 2. The Scala object which can be compiled and staged</span>
<span class="k">object</span> <span class="nc">ArgInOut</span> <span class="k">extends</span> <span class="nc">SpatialApp</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">IR._</span>

  <span class="c1">// 3. This method, main, is called on program startup.</span>
  <span class="c1">// Spatial apps are required to use the &quot;@virtualize&quot; macro</span>
  <span class="nd">@virtualize</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">()</span> <span class="o">{</span>

    <span class="c1">// 4. Declare command line input arguments</span>
    <span class="k">val</span> <span class="n">N</span> <span class="k">=</span> <span class="n">args</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">to</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>

    <span class="c1">// 5. Declare the interface between host and accelerator</span>
    <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="nc">ArgIn</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
    <span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="nc">ArgOut</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>

    <span class="c1">// 6. Explicitly communicate the input to the hardware</span>
    <span class="n">setArg</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">N</span><span class="o">)</span>

    <span class="c1">// 7. Specify algorithm to be done on hardware</span>
    <span class="nc">Accel</span> <span class="o">{</span>
      <span class="n">y</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="o">}</span>

    <span class="c1">// 8. Explicitly pull data off of the hardware</span>
    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">getArg</span><span class="o">(</span><span class="n">y</span><span class="o">)</span>

    <span class="c1">// 9. Specify algorithm to be done in software</span>
    <span class="k">val</span> <span class="n">gold</span> <span class="k">=</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;expected: &quot;</span> <span class="o">+</span> <span class="n">gold</span><span class="o">)</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;result: &quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This code can be found in: <code class="docutils literal"><span class="pre">$SPATIAL_HOME/apps/src/ArgInOutTest.scala</span></code></p>
<p>Because Spatial is a DSL for programming reconfigurable <em>hardware</em>, we will begin with the hardware equivalent of &#8220;Hello, World.&#8221;
In this app, the hardware reads some numeric argument from an off-chip source and then echoes it back to an off-chip destination.</p>
<p>Spatial apps are always divided into two parts: the portion of code that runs on the host CPU and the portion of code that gets generated as an accelerator.
In this example, the entirety of the app exists inside of <strong>(3)</strong> <code class="docutils literal"><span class="pre">main()</span></code>, and the subset of code inside of the scope prefixed with <strong>(7)</strong> <code class="docutils literal"><span class="pre">Accel</span></code> is the hardware part of the app.</p>
<p>In the ArgInOut app, we start with three declarations above the <code class="docutils literal"><span class="pre">Accel</span></code> scope:</p>
<p><strong>(4)</strong> We first declare <em>N</em> to be one of the command-line input arguments at run-time by setting it equal to <code class="docutils literal"><span class="pre">args(0)</span></code>.
We must also explicitly cast this <a class="reference internal" href="../cpu/string.html"><span class="doc">String</span></a> argument to a Spatial type by appending <code class="docutils literal"><span class="pre">.to[Int]</span></code>.</p>
<p><strong>(5)</strong> We then, declare <em>x</em> to be an <a class="reference internal" href="../accel/memories/reg.html"><span class="doc">ArgIn</span></a> of type <a class="reference internal" href="../common/fixpt.html"><span class="doc">Int</span></a> and
<em>y</em> to be an <a class="reference internal" href="../accel/memories/reg.html"><span class="doc">ArgOut</span></a> of type <a class="reference internal" href="../common/fixpt.html"><span class="doc">Int</span></a>.</p>
<p>In addition to ArgIns and ArgOuts, Spatial offers <a class="reference internal" href="../accel/memories/dram.html"><span class="doc">DRAM</span></a>, which represents an off-chip memory that
both the host and the accelerator can read from and write to.</p>
<p><strong>(6)</strong> Now that we have both a value that represents an ArgIn and another value which reads some value from the command-line at runtime,
we must connect the two with <code class="docutils literal"><span class="pre">setArg(&lt;HW</span> <span class="pre">val&gt;,</span> <span class="pre">&lt;SW</span> <span class="pre">val&gt;)</span></code>.
Similarly, we can connect a DRAM to an array with <code class="docutils literal"><span class="pre">setMem(&lt;HW</span> <span class="pre">array&gt;,</span> <span class="pre">&lt;SW</span> <span class="pre">array&gt;)</span></code>.</p>
<p><strong>(7)</strong> Next, we specify the <code class="docutils literal"><span class="pre">Accel</span></code> block.
In this particular app, we simply want to add the number <cite>4</cite> to whatever input argument is read in.
To do this, we just use the Reg <code class="docutils literal"><span class="pre">:=</span></code> operation to write our ArgOut register with <code class="docutils literal"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">4</span></code>.
In later sections, you will learn what other operations and building blocks Spatial exposes to the developer.</p>
<p><strong>(8)</strong>  After the <code class="docutils literal"><span class="pre">Accel</span></code> block, we return to the host code section of an app that will interact with the result generated by the hardware.
Specifically, we start by assigning the ArgOut register to a software variable with <code class="docutils literal"><span class="pre">getArg(&lt;HW</span> <span class="pre">val&gt;)</span></code>.
Similarly, we can assign a DRAM to a software array with <code class="docutils literal"><span class="pre">getMem(&lt;HW</span> <span class="pre">array&gt;)</span></code>.</p>
<p><strong>(9)</strong> Finally, we add any debug and validation code to check if the accelerator is performing as expected.
In this example, we compute the result we expect the hardware to give, and then <a class="reference internal" href="../cpu/debug.html"><span class="doc">print</span></a> both this number and the number we actually got.</p>
</div>
<hr class="docutils" />
<div class="section" id="compiling">
<h2>Compiling<a class="headerlink" href="#compiling" title="Permalink to this headline">¶</a></h2>
<p>Currently, you should edit and place apps inside of your <cite>${SPATIAL_HOME}/apps/src/</cite> directory.
<strong>Any time you change an app, you must remake Spatial with:</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="si">${</span><span class="nv">SPATIAL_HOME</span><span class="si">}</span> <span class="o">&amp;&amp;</span> make apps
</pre></div>
</div>
<p>Once you have a complete Spatial app, the next step is to compile and run it.
Currently, there are two available targets: Scala (for simple functional simulation) and Chisel (for FPGA).</p>
<p><strong>Compiling to Scala</strong></p>
<p>Targetting Scala is the quickest way to simulate your app and test for basic functional correctness.
It also allows <code class="docutils literal"><span class="pre">println</span></code> calls in code that exists inside the <code class="docutils literal"><span class="pre">Accel</span></code> block.
You should use this backend if you are debugging things at the algorithm level.
In order to compile and simulate for the Scala backend, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="si">${</span><span class="nv">SPATIAL_HOME</span><span class="si">}</span>/
bin/spatial &lt;app name&gt; --scala <span class="c1"># + other options</span>
</pre></div>
</div>
<p>The &#8220;&lt;app name&gt;&#8221; refers to the name of the <code class="docutils literal"><span class="pre">object</span></code>. In our app above, for example, the app name is &#8220;ArgInOut&#8221;.
See the &#8220;Testing&#8221; section below for a guide on how to test the generated app</p>
<p><strong>Compiling to Chisel</strong></p>
<p>Targeting Chisel will let you compile your app down into Berkeley&#8217;s Chisel language, which eventually compiles down to Verilog.
It also allows you to debug your app at the clock-cycle resolution. In order to compile with the Chisel backend, run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="si">${</span><span class="nv">SPATIAL_HOME</span><span class="si">}</span>
bin/spatial &lt;app name&gt; --chisel <span class="c1"># + other options</span>
</pre></div>
</div>
</div>
<div class="section" id="synthesizing-and-testing">
<h2>Synthesizing and Testing<a class="headerlink" href="#synthesizing-and-testing" title="Permalink to this headline">¶</a></h2>
<p>After you have used the <code class="docutils literal"><span class="pre">bin/spatial</span></code> script to compile the app, navigate to the generated code
directory to test the app.  By default, this is <code class="docutils literal"><span class="pre">${SPATIAL_HOME}/gen/&lt;app</span> <span class="pre">name&gt;</span></code>.  You will see some
files and directories in this folder that correspond to the code that Spatial created for the various
target platforms.
For the Chisel backend, here is a rough breakdown of what the important files are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>chisel/TopTrait.scala</td>
<td>Main trait where all of the controller and dataflow connections are made</td>
</tr>
<tr class="row-even"><td>chisel/IOModule.scala</td>
<td>Interface between FPGA accelerator and CPU</td>
</tr>
<tr class="row-odd"><td>chisel/BufferControlCxns</td>
<td>Connections for all N-buffered memories in the design</td>
</tr>
<tr class="row-even"><td>chisel/resources/*.scala</td>
<td>Files for all of the fundamental building blocks of a Spatial app</td>
</tr>
<tr class="row-odd"><td>cpp/TopHost.scala</td>
<td>Contains the Application method where all CPU code is generated</td>
</tr>
<tr class="row-even"><td>controller_tree.html</td>
<td>Helpful diagram for showing the hierarchy of control nodes in your app</td>
</tr>
</tbody>
</table>
<p>In order to finally test this code, you must compile the backend code itself. In order to do so, run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="si">${</span><span class="nv">SPATIAL_HOME</span><span class="si">}</span>/gen/&lt;app name&gt;
make sim
bash run.sh &lt;arguments&gt;
</pre></div>
</div>
<p>If using the Chisel backend, this will turn any Chisel code into Verilog, which then gets turned into C++ through Verilator.
It also compiles the Spatial-generated C++.  Finally, the <code class="docutils literal"><span class="pre">run.sh</span></code> script executes the entire application with communication between the hardware and CPU and returns the result.
If using the Scala backend, this will just test the Scala code on your machine.</p>
<p>After running a Chisel app, you can see the waveforms generated in the <code class="docutils literal"><span class="pre">test_run_dir/app.Launcher####</span></code> folder, with the <cite>.vcd</cite> extension for further debugging</p>
<p>The &#8220;&lt;arguments&gt;&#8221; should be a space-separated list, fully enclosed in quotes.  For example, an app that takes arguments 192 96 should be run with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>bash run.sh <span class="s2">&quot;192 96&quot;</span>
</pre></div>
</div>
<p>Now that you have built and tested your first app, there are a lot more things you can do in Spatial!
You may already have an algorithm in mind that you want to write, or you may want to keep exploring to get a sense of what the language can do.
Feel free to poke around the apps we have written in <code class="docutils literal"><span class="pre">${SPATIAL_HOME}/apps/src</span></code> for examples of apps.
You may also find it useful to copy/paste one of our existing apps and start tweaking it to get more interesting algorithms.
If you run into any questions or issues, you can always post on our [forum](<a class="reference external" href="https://groups.google.com/forum/#!forum/spatial-lang-users">https://groups.google.com/forum/#!forum/spatial-lang-users</a>).</p>
<p>Note that since the language is still actively under development, if one of our apps does not work and you think it should,
you should check the regression test status at the top of this README for a quick reference whether or not the app you are playing with is expected to work at the moment.</p>
<p>Next, <a class="reference internal" href="model.html"><span class="doc">learn how to build more complicated Spatial programs</span></a>.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="model.html" class="btn btn-neutral float-right" title="2. The Spatial Programming Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="starting.html" class="btn btn-neutral" title="0. Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017,Stanford PPL.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>